{% extends "base.html" %}

{% block title %}
{% if subscriber.baby_name %}{{ subscriber.baby_name }}'s{% else %}Your Baby's{% endif %} Updates — Newborn Navigator
{% endblock %}

{% block body %}
<!-- Header -->
<div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
    <div class="max-w-3xl mx-auto px-6 py-10">
        <div class="flex items-center justify-between mb-1">
            <p class="text-indigo-200 text-sm font-medium">Newborn Navigator</p>
            <a href="/" class="text-indigo-200 hover:text-white text-sm font-medium transition">Log out</a>
        </div>
        <h1 class="text-3xl font-bold">
            {% if subscriber.baby_name %}{{ subscriber.baby_name }}'s{% else %}Your Baby's{% endif %}
            Updates
        </h1>
        {% if baby_age is not none %}
        <div class="mt-4 flex items-center gap-4">
            <div class="bg-white/20 rounded-xl px-5 py-3">
                <p class="text-3xl font-bold">{{ baby_age }}</p>
                <p class="text-indigo-200 text-xs">weeks old</p>
            </div>
            {% if baby_age <= 16 %}
            <div>
                <p class="text-indigo-100 text-sm">Showing <strong>Week {{ week }}</strong> milestones and tips</p>
                {% if baby_age > 16 %}
                <p class="text-indigo-300 text-xs mt-1">Your baby is past 16 weeks — showing the latest content.</p>
                {% endif %}
            </div>
            {% else %}
            <div>
                <p class="text-indigo-100 text-sm">Your baby is past 16 weeks — amazing how fast they grow!</p>
                <p class="text-indigo-300 text-xs mt-1">Showing Week 16 milestones below.</p>
            </div>
            {% endif %}
        </div>
        {% else %}
        <p class="text-indigo-200 mt-2">Add your baby's birth date to see personalized milestones.</p>
        {% endif %}
        <p class="text-indigo-300 text-xs mt-4">Hi {{ subscriber.name or subscriber.email }}! Bookmark this page to check back anytime.</p>
    </div>
</div>

<div class="max-w-3xl mx-auto px-6 py-8">

    <!-- Local Resources -->
    <div class="mb-10">
        <a href="/my-updates/{{ token }}/local-resources"
           class="block bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md hover:border-indigo-300 transition group">
            <div class="flex items-center gap-4">
                <div class="flex-shrink-0 w-12 h-12 bg-indigo-100 rounded-xl flex items-center justify-center group-hover:bg-indigo-200 transition">
                    <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-gray-900 group-hover:text-indigo-600 transition">Local Resources</h3>
                    <p class="text-sm text-gray-500 mt-0.5">Find hospitals, pediatricians, and daycares in your NYC neighborhood.</p>
                </div>
                <svg class="w-5 h-5 text-gray-400 group-hover:text-indigo-500 transition" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
        </a>
    </div>

    <!-- Newsletter content (if exists for this week) -->
    {% if newsletter and newsletter.sections %}
    <div class="mb-10">
        <h2 class="text-xl font-bold text-gray-900 mb-4">
            {{ newsletter.title }}
        </h2>
        <div class="space-y-4">
            {% for section in newsletter.sections %}
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                {% if section.title %}
                <h3 class="text-lg font-semibold text-indigo-900 mb-2">{{ section.title }}</h3>
                {% endif %}
                <div class="text-gray-700 text-sm leading-relaxed whitespace-pre-line">{{ section.body }}</div>
                {% if section.is_paid_only %}
                <span class="inline-block mt-2 text-xs text-amber-600 font-medium bg-amber-50 px-2 py-0.5 rounded">Premium</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Milestones -->
    {% if categories %}
    <div class="mb-10">
        <h2 class="text-xl font-bold text-gray-900 mb-1">Week {{ week }} Milestones</h2>
        <p class="text-sm text-gray-500 mb-6">What to look for and things to try this week.</p>

        <div class="space-y-6">
            {% for category, items in categories.items() %}
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="bg-indigo-50 px-6 py-3 border-b border-indigo-100">
                    <h3 class="text-sm font-bold text-indigo-900 uppercase tracking-wide">{{ category }}</h3>
                </div>
                <div class="divide-y divide-gray-100">
                    {% for m in items %}
                    {% include "public/partials/milestone_card.html" %}
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Browse other weeks -->
    {% if available_issues %}
    <div class="mb-10">
        <h2 class="text-lg font-bold text-gray-900 mb-3">Other Weekly Issues</h2>
        <div class="flex flex-wrap gap-2">
            {% for issue in available_issues %}
            <a href="/my-updates/{{ token }}?week={{ issue.week_number }}"
               class="px-3 py-1.5 rounded-lg text-sm font-medium transition
                      {% if issue.week_number == week %}bg-indigo-600 text-white{% else %}bg-white text-gray-700 border border-gray-300 hover:bg-gray-50{% endif %}">
                Week {{ issue.week_number }}
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Week navigation -->
    <div class="mb-10">
        <h2 class="text-lg font-bold text-gray-900 mb-3">Browse All Weeks</h2>
        <div class="flex flex-wrap gap-2">
            {% for w in range(17) %}
            <a href="/my-updates/{{ token }}?week={{ w }}"
               class="px-3 py-1.5 rounded-lg text-sm font-medium transition
                      {% if w == week %}bg-indigo-600 text-white{% else %}bg-white text-gray-700 border border-gray-300 hover:bg-gray-50{% endif %}">
                {% if w == 0 %}Birth{% else %}Wk {{ w }}{% endif %}
            </a>
            {% endfor %}
        </div>
    </div>

</div>

<!-- Footer -->
<footer class="bg-gray-900 text-gray-400 py-8">
    <div class="max-w-3xl mx-auto px-6 text-center text-sm">
        <p>Newborn Navigator &mdash; Evidence-based guidance for new parents.</p>
        <p class="mt-2 text-gray-600">
            This is not medical advice. Always consult your pediatrician.
            &middot; <a href="/unsubscribe/{{ token }}" class="text-gray-500 hover:text-gray-300">Unsubscribe</a>
        </p>
    </div>
</footer>

<!-- Chat Widget -->
<button id="chatToggle" onclick="toggleChat()"
        class="fixed bottom-6 right-6 z-50 w-14 h-14 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-lg flex items-center justify-center transition">
    <svg id="chatIconOpen" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
    </svg>
    <svg id="chatIconClose" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
    </svg>
</button>

<div id="chatPanel" class="hidden fixed bottom-24 right-6 z-50 w-80 sm:w-96 bg-white rounded-2xl shadow-2xl border border-gray-200 flex flex-col" style="height:28rem;">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-3 rounded-t-2xl flex-shrink-0">
        <h3 class="font-semibold text-sm">Baby Navigator Assistant</h3>
        <p class="text-indigo-200 text-xs">Ask me anything about {% if subscriber.baby_name %}{{ subscriber.baby_name }}'s{% else %}your baby's{% endif %} development</p>
    </div>
    <!-- Messages -->
    <div id="chatMessages" class="flex-1 overflow-y-auto px-4 py-3 space-y-3">
        <div class="flex justify-start">
            <div class="bg-indigo-50 text-gray-800 rounded-2xl rounded-bl-sm px-3 py-2 max-w-[85%] text-sm">
                Hi{% if subscriber.baby_name %}, I'm here to help with {{ subscriber.baby_name }}'s development{% else %}! I'm here to help with your baby's development{% endif %}. Ask me anything about milestones, sleep, feeding, or general newborn care!
            </div>
        </div>
    </div>
    <!-- Input -->
    <form onsubmit="sendMessage(event)" class="flex-shrink-0 border-t border-gray-200 px-3 py-2 flex gap-2">
        <input id="chatInput" type="text" placeholder="Type a message..."
               class="flex-1 text-sm border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:border-indigo-400" autocomplete="off">
        <button type="submit" id="chatSend"
                class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-full w-9 h-9 flex items-center justify-center flex-shrink-0 transition">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19V5m0 0l-7 7m7-7l7 7"/>
            </svg>
        </button>
    </form>
</div>

<script>
const chatToken = "{{ token }}";
const chatWeek = {{ week }};
let chatMessages = [];
let chatStreaming = false;

function toggleChat() {
    const panel = document.getElementById('chatPanel');
    const iconOpen = document.getElementById('chatIconOpen');
    const iconClose = document.getElementById('chatIconClose');
    const isHidden = panel.classList.contains('hidden');
    panel.classList.toggle('hidden');
    iconOpen.classList.toggle('hidden', isHidden);
    iconClose.classList.toggle('hidden', !isHidden);
    if (isHidden) document.getElementById('chatInput').focus();
}

function appendBubble(role, text) {
    const container = document.getElementById('chatMessages');
    const wrapper = document.createElement('div');
    wrapper.className = 'flex ' + (role === 'user' ? 'justify-end' : 'justify-start');
    const bubble = document.createElement('div');
    bubble.className = role === 'user'
        ? 'bg-indigo-600 text-white rounded-2xl rounded-br-sm px-3 py-2 max-w-[85%] text-sm'
        : 'bg-indigo-50 text-gray-800 rounded-2xl rounded-bl-sm px-3 py-2 max-w-[85%] text-sm whitespace-pre-wrap';
    bubble.textContent = text;
    wrapper.appendChild(bubble);
    container.appendChild(wrapper);
    container.scrollTop = container.scrollHeight;
    return bubble;
}

async function sendMessage(e) {
    e.preventDefault();
    if (chatStreaming) return;
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;

    input.value = '';
    appendBubble('user', text);
    chatMessages.push({role: 'user', content: text});

    const bubble = appendBubble('assistant', '');
    bubble.textContent = '...';
    chatStreaming = true;
    document.getElementById('chatSend').disabled = true;

    try {
        const resp = await fetch(`/my-updates/${chatToken}/chat`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({messages: chatMessages, week: chatWeek}),
        });
        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let assistantText = '';
        bubble.textContent = '';

        while (true) {
            const {done, value} = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, {stream: true});
            const lines = chunk.split('\n');
            for (const line of lines) {
                if (!line.startsWith('data: ')) continue;
                try {
                    const data = JSON.parse(line.slice(6));
                    if (data.text) {
                        assistantText += data.text;
                        bubble.textContent = assistantText;
                        document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
                    } else if (data.error) {
                        bubble.textContent = 'Sorry, something went wrong. Please try again.';
                    }
                } catch {}
            }
        }
        if (assistantText) {
            chatMessages.push({role: 'assistant', content: assistantText});
        }
    } catch {
        bubble.textContent = 'Sorry, something went wrong. Please try again.';
    } finally {
        chatStreaming = false;
        document.getElementById('chatSend').disabled = false;
        document.getElementById('chatInput').focus();
    }
}
</script>
{% endblock %}
